<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leaderboard</title>
    
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #151522;
            --card-bg: #1E1E2E;
            --text-white: #FFFFFF;
            --text-grey: #8F9BB3;
            --rank-1-color: #FFD700;
            --rank-2-color: #00E5FF;
            --rank-3-color: #00FF7F;
            --accent-purple: #6A5ACD;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-dark); color: var(--text-white); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Loading */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .loading-spinner { border: 4px solid #2c2c3e; border-top: 4px solid var(--rank-2-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Header */
        .header { padding: 20px 20px 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .icon-btn { color: var(--text-white); font-size: 20px; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        /* Tabs */
        .tabs-container { display: flex; justify-content: center; background: #232336; margin: 10px 20px; padding: 4px; border-radius: 12px; }
        .tab-btn { flex: 1; background: transparent; border: none; color: var(--text-grey); padding: 10px 0; font-size: 14px; font-weight: 500; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .tab-btn.active { background: #2F2F42; color: var(--text-white); position: relative; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: var(--rank-2-color); border-radius: 2px; }

        /* Podium */
        .podium-container { display: flex; justify-content: center; align-items: flex-end; padding: 30px 20px 40px 20px; position: relative; z-index: 1; }
        .podium-item { display: flex; flex-direction: column; align-items: center; position: relative; text-align: center; }
        .p-avatar-box { position: relative; margin-bottom: 10px; }
        .p-avatar-img { border-radius: 50%; object-fit: cover; border: 3px solid transparent; }
        .p-badge { position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; color: white; z-index: 10; }
        .p-name { font-size: 14px; font-weight: 600; margin-top: 5px; color: var(--text-white); }
        .p-score { font-size: 16px; font-weight: 700; margin-top: 2px; }
        .p-username { font-size: 11px; color: var(--text-grey); font-weight: 400; }

        /* Rank Styles */
        .rank-2 { margin-right: -10px; z-index: 2; padding-bottom: 10px; }
        .rank-2 .p-avatar-img { width: 70px; height: 70px; border-color: var(--rank-2-color); box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        .rank-2 .p-badge { background: var(--rank-2-color); clip-path: polygon(50% 100%, 0 0, 100% 0); height: 20px; padding-bottom: 5px; font-size: 10px; }
        .rank-2 .p-score { color: var(--rank-2-color); }

        .rank-1 { z-index: 3; margin-bottom: 25px; }
        .rank-1 .crown-icon { color: var(--rank-1-color); font-size: 24px; margin-bottom: 8px; filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5)); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .rank-1 .p-avatar-box { width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; background: linear-gradient(180deg, var(--rank-1-color) 0%, transparent 100%); border-radius: 50%; padding: 3px; }
        .rank-1 .p-avatar-img { width: 100%; height: 100%; border: 4px solid #1a1a2e; }
        .rank-1 .p-badge { background: var(--rank-1-color); border-radius: 50%; bottom: -12px; width: 28px; height: 28px; border: 3px solid #1a1a2e; color: #1a1a2e; }
        .rank-1 .p-score { color: var(--rank-1-color); font-size: 20px; }

        .rank-3 { margin-left: -10px; z-index: 2; padding-bottom: 10px; }
        .rank-3 .p-avatar-img { width: 70px; height: 70px; border-color: var(--rank-3-color); box-shadow: 0 0 15px rgba(0, 255, 127, 0.3); }
        .rank-3 .p-badge { background: var(--rank-3-color); border-radius: 50%; bottom: -8px; border: 2px solid #1a1a2e; color: #1a1a2e; }
        .rank-3 .p-score { color: var(--rank-3-color); }

        /* List Section */
        .list-container { flex: 1; background: #10101C; border-top-left-radius: 30px; border-top-right-radius: 30px; padding: 20px 20px 0 20px; overflow-y: auto; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); border-top: 1px solid #232336; }
        .list-item { display: flex; align-items: center; padding: 12px 10px; margin-bottom: 5px; border-bottom: 1px solid #232336; border-radius: 10px; }
        
        /* Highlight Current User */
        .list-item.is-me { background: rgba(0, 229, 255, 0.1); border: 1px solid rgba(0, 229, 255, 0.3); }
        
        .list-avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 1px solid #333; }
        .list-info { flex: 1; display: flex; flex-direction: column; }
        .list-name { font-size: 14px; font-weight: 500; color: var(--text-white); }
        .list-username { font-size: 12px; color: var(--text-grey); }
        .list-score { font-size: 14px; font-weight: 700; color: var(--text-white); }
        .rank-change { font-size: 10px; margin-top: 2px; color: var(--rank-3-color); }
    </style>
</head>
<body>
    
    <div id="loading-screen"><div class="loading-spinner"></div></div>

    <div class="header">
        <div class="icon-btn" onclick="goBackToApp()"><i class="fas fa-chevron-left"></i></div>
        <h1>Leaderboard</h1>
        <div class="icon-btn"><i class="fas fa-th-large"></i></div>
    </div>

    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab(this, 'balance')">Coins</button>
        <button class="tab-btn" onclick="switchTab(this, 'referrals')">Referrals</button>
        <button class="tab-btn" onclick="switchTab(this, 'level')">Level</button>
    </div>

    <div class="podium-container">
        <!-- Rank 2 -->
        <div class="podium-item rank-2">
            <div class="p-avatar-box">
                <img id="podiumAvatar2" class="p-avatar-img" src="" alt="">
                <div class="p-badge">2</div>
            </div>
            <div class="p-name" id="podiumName2">--</div>
            <div class="p-score" id="podiumScore2">0</div>
            <div class="p-username" id="podiumUser2"></div>
        </div>
        <!-- Rank 1 -->
        <div class="podium-item rank-1">
            <i class="fas fa-crown crown-icon"></i>
            <div class="p-avatar-box">
                <img id="podiumAvatar1" class="p-avatar-img" src="" alt="">
                <div class="p-badge">1</div>
            </div>
            <div class="p-name" id="podiumName1">--</div>
            <div class="p-score" id="podiumScore1">0</div>
            <div class="p-username" id="podiumUser1"></div>
        </div>
        <!-- Rank 3 -->
        <div class="podium-item rank-3">
            <div class="p-avatar-box">
                <img id="podiumAvatar3" class="p-avatar-img" src="" alt="">
                <div class="p-badge">3</div>
            </div>
            <div class="p-name" id="podiumName3">--</div>
            <div class="p-score" id="podiumScore3">0</div>
            <div class="p-username" id="podiumUser3"></div>
        </div>
    </div>

    <div class="list-container" id="leaderboardList"></div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC3Lef_4TPia7sJA0nEFC7Byc1xSyUxyA0",
            authDomain: "snowman-adventure-4fa71.firebaseapp.com",
            databaseURL: "https://snowman-adventure-4fa71-default-rtdb.firebaseio.com",
            projectId: "snowman-adventure-4fa71",
            storageBucket: "snowman-adventure-4fa71.firebasestorage.app",
            messagingSenderId: "507867054186",
            appId: "1:507867054186:web:12d024de606d00091b4a13",
            measurementId: "G-J550E6L22Z"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const defaultAvatar = "https://alamin12071985-a11y.github.io/Snowman-Adventure/snowman.webp";

        // --- TELEGRAM INIT ---
        const tg = window.Telegram.WebApp;
        tg.expand(); // Fullscreen mode

        // বর্তমান ইউজার ডাটা (যদি টেলিগ্রাম থেকে ওপেন হয়)
        let currentTgUser = null;
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            currentTgUser = tg.initDataUnsafe.user;
        }

        // --- FUNCTIONS ---
        const loadingScreen = document.getElementById('loading-screen');
        const leaderboardList = document.getElementById('leaderboardList');

        function goBackToApp() {
            if (tg) tg.close();
            else history.back();
        }

        function switchTab(btn, orderBy) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            fetchLeaderboard(orderBy);
        }

        // 1. Firebase এ ইউজার ডাটা আপডেট করা (যাতে লিডারবোর্ডে Real ছবি আসে)
        function syncUser() {
            if (!currentTgUser) return; // টেলিগ্রামে ওপেন না হলে স্কিপ করবে

            const userId = currentTgUser.id;
            // শুধু নাম আর ছবি আপডেট করবো, কয়েন বা লেভেল নয়
            db.ref('users/' + userId).update({
                username: currentTgUser.username || '',
                first_name: currentTgUser.first_name || 'Unknown',
                photo_url: currentTgUser.photo_url || defaultAvatar, // টেলিগ্রামের রিয়েল ফটো
                last_active: firebase.database.ServerValue.TIMESTAMP
            });
        }

        async function fetchLeaderboard(orderBy, limit = 50) {
            try {
                const snapshot = await db.ref('users')
                    .orderByChild(orderBy)
                    .limitToLast(limit)
                    .once('value');
                
                let users = [];
                snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    users.push({
                        id: childSnapshot.key, // Firebase Key (usually TG ID)
                        name: data.first_name || data.username || 'Anonymous',
                        username: data.username ? `@${data.username}` : '',
                        avatar: data.photo_url || defaultAvatar,
                        score: data[orderBy] || 0,
                    });
                });

                users.reverse(); // Descending order
                updateUI(users);

            } catch (error) {
                console.error("Error:", error);
            }
            
            loadingScreen.style.opacity = '0';
            setTimeout(() => loadingScreen.style.display = 'none', 500);
        }

        function updateUI(users) {
            // 1. Podium Setup
            for(let i=1; i<=3; i++) {
                document.getElementById(`podiumName${i}`).innerText = '-';
                document.getElementById(`podiumScore${i}`).innerText = '0';
                document.getElementById(`podiumAvatar${i}`).src = defaultAvatar;
                document.getElementById(`podiumUser${i}`).innerText = '';
            }

            if(users[0]) fillPodium(1, users[0]);
            if(users[1]) fillPodium(2, users[1]);
            if(users[2]) fillPodium(3, users[2]);

            // 2. List Setup
            const listUsers = users.slice(3);
            leaderboardList.innerHTML = '';

            listUsers.forEach((user, index) => {
                const rank = index + 4;
                // চেক করি এটাই বর্তমান ইউজার কিনা
                const isMe = currentTgUser && (String(user.id) === String(currentTgUser.id));
                
                const item = document.createElement('div');
                item.className = `list-item ${isMe ? 'is-me' : ''}`; // নিজেকে হাইলাইট করার ক্লাস
                
                item.innerHTML = `
                    <div style="width: 30px; text-align: center; font-weight: 600; font-size: 14px; color: #8F9BB3;">${rank}</div>
                    <img class="list-avatar" src="${user.avatar}" alt="user">
                    <div class="list-info">
                        <span class="list-name">${user.name} ${isMe ? '(You)' : ''}</span>
                        <span class="list-username">${user.username}</span>
                    </div>
                    <div style="text-align: right;">
                        <span class="list-score">${Math.floor(user.score).toLocaleString()}</span>
                        <div class="rank-change"><i class="fas fa-caret-up"></i></div>
                    </div>
                `;
                leaderboardList.appendChild(item);
            });
        }

        function fillPodium(rank, user) {
            const elName = document.getElementById(`podiumName${rank}`);
            const elUser = document.getElementById(`podiumUser${rank}`);
            const elScore = document.getElementById(`podiumScore${rank}`);
            const elAvatar = document.getElementById(`podiumAvatar${rank}`);

            elName.innerText = user.name.length > 10 ? user.name.substring(0,8)+'..' : user.name;
            elUser.innerText = user.username;
            elScore.innerText = Math.floor(user.score).toLocaleString();
            elAvatar.src = user.avatar;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            syncUser(); // ১. টেলিগ্রাম ডাটা Firebase এ পাঠাই
            fetchLeaderboard('balance'); // ২. তারপর লিডারবোর্ড লোড করি
        });

    </script>
</body>
</html>
